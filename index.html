<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🇯🇵 互動式東京家庭自助旅遊行程 ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #fefbff;
            --sidebar-bg: #ffffff;
            --content-bg: #ffffff;
            --nav-hover-bg: #fce7f3;
            --nav-active-bg: linear-gradient(135deg, #f9a8d4, #f472b6);
            --nav-text: #be185d;
            --nav-active-text: #ffffff;
            --card-border: #fbcfe8;
            --title-color: #db2777;
            --text-color: #374151;
            --warning-bg: #fef2f2;
            --warning-border: #f87171;
            --caution-bg: #fffbeb;
            --caution-border: #f59e0b;
            --tip-bg: #f0fdf4;
            --tip-border: #4ade80;
            --tab-bg: #fdf2f8;
            --tab-active-bg: #f472b6;
            --tab-text: #db2777;
            --tab-active-text: #ffffff;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Mochiy+Pop+One', sans-serif;
        }
        .main-layout { display: flex; }
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 1.5rem;
            border-right: 1px solid #f3e8ff;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        .main-content {
            margin-left: 250px;
            width: calc(100% - 250px);
            padding: 2.5rem;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            color: var(--nav-text);
            transition: all 0.2s ease;
        }
        .nav-link:hover {
            background-color: var(--nav-hover-bg);
            transform: translateX(5px);
        }
        .nav-link.active {
            background: var(--nav-active-bg);
            color: var(--nav-active-text);
            box-shadow: 0 4px 15px -2px rgba(244, 114, 182, 0.4);
        }
        .nav-link svg { transition: all 0.2s ease; }
        .nav-link.active svg { fill: white; }
        .content-section {
            display: none;
            animation: fadeInContent 0.6s ease;
        }
        .content-section.active { display: block; }
        .card {
            background-color: var(--content-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
            border: 1px solid var(--card-border);
        }
        .details-table{width:100%;border-collapse:collapse;margin-top:1rem;font-size: 0.9rem;}.details-table th,.details-table td{border:1px solid #e5e7eb;padding:.75rem;text-align:left;vertical-align:top}.details-table th{background-color:#f9fafb;width:100px;font-weight:bold;}
        .warning-box{background-color:var(--warning-bg);border-left:4px solid var(--warning-border);padding:1rem;border-radius:.5rem}
        .caution-box{background-color:var(--caution-bg);border-left:4px solid var(--caution-border);padding:1rem;border-radius:.5rem}
        .tip-box{background-color:var(--tip-bg);border-left:4px solid var(--tip-border);padding:1rem;border-radius:.5rem}
        .flight-card{background:linear-gradient(135deg,#fdf2f8,#fce7f3);border:1px solid var(--card-border)}
        .day-tab-button, .todo-tab-button {background-color:var(--tab-bg);color:var(--tab-text);font-weight:700;padding:.5rem 1.25rem;border-radius:9999px;transition:all .3s ease}.day-tab-button.active, .todo-tab-button.active{background-color:var(--tab-active-bg);color:var(--tab-active-text);transform:translateY(-2px);box-shadow:0 4px 10px rgba(244,114,182,.3)}
        .day-plan-content, .todo-content {display:none}.day-plan-content.active, .todo-content.active {display:block;animation:fadeInContent 0.5s ease;}
        .summary-box { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .todo-item { display: flex; align-items: flex-start; }
        .todo-item input { margin-top: 5px; }
        .mobile-header { display: none; }
        
        /* Responsive */
        @media (max-width: 768px) {
            body { padding-top: 60px; }
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
            .mobile-header {
                display: flex;
                overflow-x: auto;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background-color: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                z-index: 90;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .mobile-nav-link {
                flex-shrink: 0;
                text-align: center;
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
                color: var(--nav-text);
                border-bottom: 3px solid transparent;
                transition: all 0.2s ease;
            }
            .mobile-nav-link.active {
                color: var(--title-color);
                border-bottom-color: var(--title-color);
            }
            .details-table { font-size: 12px; }
            .details-table th, .details-table td { padding: 0.5rem; }
        }
        @keyframes fadeInContent { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
        /* Modal styles */
        .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.6);animation:fadeIn .3s}.modal-content{position:relative;margin:5% auto;padding:20px;width:90%;max-width:800px;animation:slideIn .3s}.close-button{position:absolute;top:-15px;right:-15px;width:36px;height:36px;border-radius:50%;background:#fff;color:#333;font-size:24px;line-height:36px;text-align:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2)}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{transform:translateY(-50px)}to{transform:translateY(0)}}.map-container{position:relative;overflow:hidden;width:100%;padding-top:56.25%}.map-container iframe{position:absolute;top:0;left:0;bottom:0;right:0;width:100%;height:100%;border:0}
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <header class="mobile-header">
        <a href="#" class="mobile-nav-link active" onclick="showSection('overview', event)">✨ 總覽</a>
        <a href="#" class="mobile-nav-link" onclick="showSection('daily-plan', event)">🗓️ 行程</a>
        <a href="#" class="mobile-nav-link" onclick="showSection('expenses', event)">💰 花費</a>
        <a href="#" class="mobile-nav-link" onclick="showSection('shopping-list', event)">🛍️ 待買</a>
        <a href="#" class="mobile-nav-link" onclick="showSection('todo-list', event)">✅ 待辦</a>
        <a href="#" class="mobile-nav-link" onclick="showSection('resources', event)">💡 資訊</a>
    </header>

    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="text-center mb-10">
                <h1 class="text-2xl font-bold text-[var(--title-color)]">🇯🇵 東京之旅</h1>
                <p class="text-sm text-gray-400">家庭行程規劃</p>
            </div>
            <nav class="space-y-3">
                <a href="#" class="nav-link active" onclick="showSection('overview', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><span>行程總覽</span></a>
                <a href="#" class="nav-link" onclick="showSection('daily-plan', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg><span>每日行程</span></a>
                <a href="#" class="nav-link" onclick="showSection('expenses', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V4zm2 2a1 1 0 00-1 1v2a1 1 0 001 1h12a1 1 0 001-1V7a1 1 0 00-1-1H4zM4 12a1 1 0 011-1h1a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2zm5 0a1 1 0 011-1h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2zm5 0a1 1 0 011-1h1a1 1 0 011 1v2a1 1 0 01-1 1h-1a1 1 0 01-1-1v-2z"></path></svg><span>每日花費</span></a>
                <a href="#" class="nav-link" onclick="showSection('shopping-list', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path></svg><span>待買清單</span></a>
                <a href="#" class="nav-link" onclick="showSection('todo-list', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg><span>待辦事項</span></a>
                <a href="#" class="nav-link" onclick="showSection('resources', event)"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg><span>其他資訊</span></a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ... existing content sections ... -->
            <section id="expenses" class="content-section">
                <h2 class="text-3xl font-bold text-[var(--title-color)] mb-6">每日花費紀錄</h2>
                <div class="card mb-6">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-xl text-purple-600">新增一筆花費</h3>
                        <div>
                            <label for="receipt-upload" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition shadow-md cursor-pointer text-sm">📷 拍照記帳</label>
                            <input type="file" id="receipt-upload" accept="image/*" class="hidden">
                        </div>
                    </div>
                    <div id="ocr-status" class="text-sm text-gray-500 mb-4 hidden"></div>
                    <form id="expense-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="col-span-1"><label class="block text-sm font-medium">日期</label><select id="expense-date" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>9/3</option><option>9/4</option><option>9/5</option><option>9/6</option><option>9/7</option></select></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">時間</label><input type="time" id="expense-time" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">地點</label><input type="text" id="expense-location" placeholder="如: 澀谷" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">類別</label><select id="expense-category" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>餐飲</option><option>交通</option><option>購物</option><option>藥妝</option><option>伴手禮</option><option>玩具</option><option>便利商店</option><option>景點門票</option><option>住宿</option><option>雜費</option><option>其他</option></select></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">描述*</label><input type="text" id="expense-desc" placeholder="如: 一蘭拉麵" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">日幣 (JPY)*</label><input type="number" id="expense-jpy" placeholder="1000" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">支付方式</label><select id="expense-payment" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>現鈔</option><option>Suica</option><option>信用卡</option><option>行動支付</option></select></div>
                        <div class="col-span-1"><label class="block text-sm font-medium">卡片/備註</label><input type="text" id="expense-notes" placeholder="如: 熊本熊卡" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div class="col-span-full"><button type="submit" class="w-full bg-pink-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-600 transition shadow-md">新增紀錄</button></div>
                    </form>
                </div>
                
                <div class="card mb-6">
                    <h3 class="font-bold text-xl mb-4 text-purple-600">💳 Suica 管理</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold text-lg mb-2">目前餘額</h4>
                            <p class="text-4xl font-bold text-gray-800" id="suica-balance">¥ 0</p>
                        </div>
                        <div>
                             <h4 class="font-bold text-lg mb-2">儲值</h4>
                            <form id="suica-topup-form" class="flex gap-2 items-center">
                                <input type="number" id="suica-topup-amount" placeholder="儲值金額 (JPY)" required class="flex-grow rounded-md border-gray-300 shadow-sm">
                                <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">新增</button>
                            </form>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold text-lg mb-2">儲值紀錄</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                               <thead><tr class="bg-gray-50"><th class="p-2 text-left">日期</th><th class="p-2 text-left">儲值金額 (JPY)</th><th class="p-2"></th></tr></thead>
                               <tbody id="suica-topup-list"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                     <div class="flex flex-wrap justify-between items-center mb-4">
                        <h3 class="font-bold text-xl text-purple-600">花費總覽</h3>
                        <button id="export-md-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition shadow-md text-sm">匯出 Markdown</button>
                    </div>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm">
                            <thead><tr class="bg-gray-50"><th class="p-2 text-left">日期</th><th class="p-2 text-left">描述</th><th class="p-2 text-left">日幣</th><th class="p-2 text-left">支付</th><th class="p-2 text-left">卡片/備註</th><th class="p-2"></th></tr></thead>
                            <tbody id="expense-list"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-bold text-xl mt-6 mb-4 text-purple-600">依支付方式統計</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">支付方式</th><th class="p-2 text-left">總金額 (JPY)</th><th class="p-2 text-left">總金額 (TWD)</th></tr></thead>
                                    <tbody id="summary-list"></tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl mt-6 mb-4 text-purple-600">依卡片統計</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="p-2 text-left">卡片/備註</th><th class="p-2 text-left">總金額 (JPY)</th><th class="p-2 text-left">總金額 (TWD)</th></tr></thead>
                                    <tbody id="card-summary-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="shopping-list" class="content-section">
                <h2 class="text-3xl font-bold text-[var(--title-color)] mb-6">🛍️ 待買清單</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-blue-600">Mike</h3>
                        <div id="shopping-list-mike" class="space-y-2 mb-4"></div>
                        <form id="new-item-form-mike" class="flex gap-2 mt-4">
                            <input type="text" id="new-item-mike" placeholder="新增待買項目..." class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">新增</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-pink-500">Edith</h3>
                        <div id="shopping-list-edith" class="space-y-2 mb-4"></div>
                        <form id="new-item-form-edith" class="flex gap-2 mt-4">
                            <input type="text" id="new-item-edith" placeholder="新增待買項目..." class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <button type="submit" class="bg-pink-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-500 transition">新增</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-yellow-500">Nini</h3>
                        <div id="shopping-list-nini" class="space-y-2 mb-4"></div>
                        <form id="new-item-form-nini" class="flex gap-2 mt-4">
                            <input type="text" id="new-item-nini" placeholder="新增待買項目..." class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <button type="submit" class="bg-yellow-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-500 transition">新增</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-green-500">Ada</h3>
                        <div id="shopping-list-ada" class="space-y-2 mb-4"></div>
                        <form id="new-item-form-ada" class="flex gap-2 mt-4">
                            <input type="text" id="new-item-ada" placeholder="新增待買項目..." class="flex-grow rounded-md border-gray-300 shadow-sm">
                            <button type="submit" class="bg-green-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-500 transition">新增</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="todo-list" class="content-section">
                <h2 class="text-3xl font-bold text-[var(--title-color)] mb-6">待辦事項</h2>
                <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
                    <button class="todo-tab-button active" onclick="showTodoTab('todo-7day', event)">7天內待辦</button>
                    <button class="todo-tab-button" onclick="showTodoTab('todo-3day', event)">3天內待辦</button>
                    <button class="todo-tab-button" onclick="showTodoTab('todo-items', event)">要帶物品</button>
                </div>
                <div id="todo-7day" class="todo-content active card">
                    <h3 class="font-bold text-xl mb-3 text-purple-600">✅ 行前 7 天內需確認事項</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>手機漫遊網路 [Edith]</span></label>
                        <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>手機漫遊網路 [Mike]</span></label>
                        <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>手機漫遊網路 [eSim]</span></label>
                        <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>手機漫遊網路 [Nini Watch]</span></label>
                        <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>提領日幣 <span class="font-bold text-pink-500 ml-2">145,000</span></span></label>
                    </div>
                </div>
                <div id="todo-3day" class="todo-content card">
                    <h3 class="font-bold text-xl mb-3 text-purple-600">✅ 行前 3 天內需確認事項</h3>
                    <div class="space-y-2">
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認護照</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認出發日去機場計程車</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認行李跟包包 [Edith]</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認行李跟包包 [Mike]</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認行李跟包包 [Nini]</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>確認行李跟包包 [Ada]</span></label>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>再次確認行程、預約、現金(145,000)</span></label>
                        <div class="pl-8 space-y-2">
                            <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>玉山 Wallet + Paypay[熊本熊]</span></label>
                            <label class="flex items-center"><input type="checkbox" checked class="w-5 h-5 mr-3"><span>玉山 Wallet + 日幣帳戶(76,059)</span></label>
                        </div>
                        <label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>再次確認信用卡實體卡國外感應支付開通</span></label>
                    </div>
                </div>
                <div id="todo-items" class="todo-content">
                    <div class="space-y-6">
                        <div class="card"><h4 class="font-bold text-xl mb-3 text-purple-600">行李箱(大)</h4><h5 class="font-bold text-lg mt-4 mb-2 text-pink-500">食 🥪</h5><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2"><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>保久乳(6罐)</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>奶瓶(奶瓶刷)</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>小朋友用餐具(剪刀注意！！)</span></label><div class="col-span-full font-semibold">藥品包:</div><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>止痛藥</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>感冒藥水</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>勝克敏</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>甲亢藥</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>專思達</span></label></div><h5 class="font-bold text-lg mt-4 mb-2 text-blue-500">衣 👕</h5><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2"><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>替換內衣褲, 襪子</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>舒適上衣、下著各數件</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>輕便外套、防風防水外套</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>帽子, 輕便雨衣(迪士尼)</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>睡衣, 髮夾、髮圈等</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>尿布20片, 護墊</span></label></div><h5 class="font-bold text-lg mt-4 mb-2 text-green-500">住 🏨</h5><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2"><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>壓縮袋, 收納袋</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>盥洗包, [Edith] 化妝品包</span></label><div class="col-span-full font-semibold">電器包:</div><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>充電器, 萬用插座</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>電源線(六條)</span></label><label class="flex items-center pl-4"><input type="checkbox" class="w-5 h-5 mr-3"><span>手錶充電線(兩條)</span></label></div></div>
                        <div class="card"><h4 class="font-bold text-xl mb-3 text-purple-600">隨身背包</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="text-sm"><h5 class="font-bold mb-2">Mike</h5><div class="pl-4 space-y-1"><p class="font-semibold">後背包:</p><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>太陽眼鏡</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>行動電源(含線)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>iPad Air</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>文石電子閱讀器</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>RedMi Note 14 Pro+5G</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>藍牙耳機</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>雨傘</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>台灣文件包</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>保溫瓶(空)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>涼風扇</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>涼毛巾</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>帽子</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>隨身文件包(護照)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>電動刮鬍刀(充飽電)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>電動牙刷(充飽電)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>擴充電源分接頭</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>證件包</span></label></div><p class="font-semibold mt-2">側背包:</p><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>耳機</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>日幣零錢包</span></label></div></div></div><div class="text-sm"><h5 class="font-bold mb-2">Edith</h5><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>隨身乳液(100CC)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>防曬乳</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>行動電源(含線)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>雨傘</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>護墊</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>脖枕 (非常重要)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>綁頭髮的工具</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>太陽眼鏡</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>口罩</span></label><p class="font-semibold mt-2">藥品包:</p><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>止痛藥</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>防蚊液</span></label></div></div></div><div class="text-sm"><h5 class="font-bold mb-2">Nini</h5><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>水壺(空)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>太陽眼鏡</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>筆記本&筆</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>雨傘</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>帽子</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>涼風扇</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>行動電源(含線)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>行程小本</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>口罩</span></label></div></div><div class="text-sm"><h5 class="font-bold mb-2">Ada</h5><div class="pl-4 space-y-1"><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>水壺(空)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>行動電源(含線)</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>太陽眼鏡</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>隨身尿布</span></label><label class="flex items-center"><input type="checkbox" class="w-4 h-4 mr-2"><span>口罩</span></label></div></div></div></div>
                        <div class="card"><h4 class="font-bold text-xl mb-3 text-purple-600">其他行李</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2"><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>行李箱（中）</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>輕便推車（Yoyo）</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>安撫娃娃(Nini/Ada), 臭臭被</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>紀念品擴充用袋子</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>折疊野餐墊</span></label></div></div>
                        <div class="card"><h4 class="font-bold text-xl mb-3 text-gray-500">最後提醒</h4><div class="grid grid-cols-1 gap-y-2"><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>每日出發前再次檢查重要證件及貴重物</span></label><label class="flex items-center"><input type="checkbox" class="w-5 h-5 mr-3"><span>查閱目的地禁帶物品、海關限令</span></label></div></div>
                    </div>
                </div>
            </section>

            <section id="resources" class="content-section">
                <h2 class="text-3xl font-bold text-[var(--title-color)] mb-6">其他資訊</h2>
                <div class="space-y-6">
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-purple-600">👨‍👩‍👧‍👧 額外建議</h3>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li>**家庭成員考量：** 兩個女兒（10歲/4歲）的年齡差異較大，行程安排上需兼顧兩者的興趣。</li>
                            <li>**彈性行程：** 若孩子疲憊或對某景點特別感興趣，可適時調整行程。</li>
                            <li>**緊急情況：** 隨身攜帶護照影本、旅遊保險資訊，並記下台灣駐日代表處的電話。</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-purple-600">🚨 應急與替代方案</h3>
                         <ul class="list-disc list-inside space-y-2 text-sm">
                            <li>**天氣不佳或預定失敗：** 可將戶外行程調整為室內購物中心或景點（如東京鐵塔、晴空塔）。</li>
                            <li>**交通延誤：** 東京的鐵路系統非常發達，若JR線延誤，可快速查詢Google Maps尋找替代的地鐵路線。</li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-xl mb-3 text-purple-600">🏥 健康與安全細節</h3>
                        <ul class="list-disc list-inside space-y-2 text-sm">
                            <li>**東京當地醫療資源：** 品川車站附近有NTT東日本關東醫院或品川綜合醫院。</li>
                            <li>**最新入境要求：** 出發前務必查詢日本台灣交流協會或日本觀光局的官方網站。</li>
                            <li>**個人衛生：** 隨身攜帶酒精濕紙巾或乾洗手液。</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Expense Modal -->
    <div id="edit-expense-modal" class="modal">
        <div class="modal-content card">
            <span class="close-button" id="close-edit-modal">&times;</span>
            <h3 class="font-bold text-xl mb-4 text-purple-600">編輯花費</h3>
             <form id="edit-expense-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div class="col-span-1"><label class="block text-sm font-medium">日期</label><select id="edit-expense-date" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>9/3</option><option>9/4</option><option>9/5</option><option>9/6</option><option>9/7</option></select></div>
                <div class="col-span-1"><label class="block text-sm font-medium">時間</label><input type="time" id="edit-expense-time" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="col-span-1"><label class="block text-sm font-medium">地點</label><input type="text" id="edit-expense-location" placeholder="如: 澀谷" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="col-span-1"><label class="block text-sm font-medium">類別</label><select id="edit-expense-category" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>餐飲</option><option>交通</option><option>購物</option><option>藥妝</option><option>伴手禮</option><option>玩具</option><option>便利商店</option><option>景點門票</option><option>住宿</option><option>雜費</option><option>其他</option></select></div>
                <div class="col-span-1"><label class="block text-sm font-medium">描述*</label><input type="text" id="edit-expense-desc" placeholder="如: 一蘭拉麵" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="col-span-1"><label class="block text-sm font-medium">日幣 (JPY)*</label><input type="number" id="edit-expense-jpy" placeholder="1000" required class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="col-span-1"><label class="block text-sm font-medium">支付方式</label><select id="edit-expense-payment" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option>現鈔</option><option>Suica</option><option>信用卡</option><option>行動支付</option></select></div>
                <div class="col-span-1"><label class="block text-sm font-medium">卡片/備註</label><input type="text" id="edit-expense-notes" placeholder="如: 熊本熊卡" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                <div class="col-span-full"><button type="submit" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition shadow-md">儲存變更</button></div>
            </form>
        </div>
    </div>

    <div id="mapModal" class="modal">
        <div class="modal-content bg-transparent"><span class="close-button" onclick="closeMap()">&times;</span><div id="mapContent" class="map-container rounded-2xl overflow-hidden"></div></div>
    </div>

    <script>
        // --- Navigation and UI Logic ---
        function showSection(sectionId,event){event.preventDefault();document.querySelectorAll(".content-section").forEach(e=>{e.classList.remove("active")});document.getElementById(sectionId).classList.add("active");document.querySelectorAll(".nav-link, .mobile-nav-link").forEach(e=>{e.classList.remove("active")});const linkSelector=`a[onclick="showSection('${sectionId}', event)"]`;document.querySelectorAll(linkSelector).forEach(e=>e.classList.add("active"));}
        function showDayPlan(dayId,event){event.preventDefault();document.querySelectorAll(".day-plan-content").forEach(e=>{e.classList.remove("active")});document.getElementById(dayId).classList.add("active");document.querySelectorAll(".day-tab-button").forEach(e=>{e.classList.remove("active")});event.currentTarget.classList.add("active")}
        function showTodoTab(tabId,event){event.preventDefault();document.querySelectorAll(".todo-content").forEach(e=>{e.classList.remove("active")});document.getElementById(tabId).classList.add("active");document.querySelectorAll(".todo-tab-button").forEach(e=>{e.classList.remove("active")});event.currentTarget.classList.add("active")}
        
        const mapModal=document.getElementById("mapModal"),mapContent=document.getElementById("mapContent"),maps={map1:'<iframe src="https://www.google.com/maps/embed?pb=!1m28!1m12!1m3!1d51906.10616947932!2d19.70962510824444!3d35.59981935008062!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!4m13!3e3!4m5!1s0x6018640ba43192e3%A0xd32c3a9d146f8df!2z5pel5pys5p2x5Lqs6YO95aSn55Sw5Y2A576955Sw56m65riv576955Sw5qmf5aC0ICjmnbHkuqzlnIvpmpvmqZ_loLQpIChITkQp!3m2!1d35.5482964!2d139.7779951!4m5!1s0x60188a5760190fa7%A0x762af933935909b0!2z5ZOB5bed546L5a2Q5aSn6aOv5bqXIDQgQ2hvbWUtMTAtMzAgVGFrYW5hd2EsIE1pbmF0byBDaXR5LCBUb2t5byAxMDgtODYxMeaXpeacrA!3m2!1d35.6279119!2d139.7367526!5e0!3m2!1szh-TW!2stw!4v1755583534678!5m2!1szh-TW!2stw" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>'};
        function showMap(mapId){mapContent.innerHTML=maps[mapId];mapModal.style.display="block"}
        function closeMap(){mapContent.innerHTML="";mapModal.style.display="none"}
        window.onclick=function(event){if(event.target==mapModal||event.target==editExpenseModal){closeMap();closeEditModal()}};

        // --- Shared Variables and Functions ---
        const FIXED_RATE = 0.21;
        
        // --- Expense Tracker Logic ---
        const expenseForm = document.getElementById('expense-form');
        const expenseList = document.getElementById('expense-list');
        const summaryList = document.getElementById('summary-list');
        const cardSummaryList = document.getElementById('card-summary-list');
        const exportBtn = document.getElementById('export-md-btn');
        const expenseStorageKey = 'tokyoTripExpenses_v5';
        let currentlyEditingIndex = null;

        const editExpenseModal = document.getElementById('edit-expense-modal');
        const editExpenseForm = document.getElementById('edit-expense-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal');

        function getExpenses() { return JSON.parse(localStorage.getItem(expenseStorageKey)) || []; }
        function saveExpenses(expenses) { localStorage.setItem(expenseStorageKey, JSON.stringify(expenses)); renderAll(); }
        
        function renderAll() {
            renderExpenses();
            renderSuicaCard();
        }

        function renderExpenses() {
            const expenses = getExpenses();
            expenseList.innerHTML = '';
            
            if (expenses.length === 0) {
                expenseList.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400 py-4">尚未有任何花費紀錄</td></tr>';
            } else {
                expenses.forEach((expense, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="p-2">${expense.date || '-'}</td>
                        <td class="p-2">${expense.location || '-'}</td>
                        <td class="p-2">${expense.desc}</td>
                        <td class="p-2">${expense.jpy.toLocaleString()}</td>
                        <td class="p-2">${expense.payment}</td>
                        <td class="p-2">${expense.notes || '-'}</td>
                        <td class="p-2 text-center whitespace-nowrap">
                            <button onclick="openEditModal(${index})" class="text-blue-500 hover:text-blue-700 text-xs mr-2">編輯</button>
                            <button onclick="deleteExpense(${index})" class="text-red-500 hover:text-red-700 text-xs">刪除</button>
                        </td>
                    `;
                    expenseList.appendChild(row);
                });
            }
            renderSummary(expenses);
        }

        function renderSummary(expenses) {
            const paymentSummary = {};
            const cardSummary = {};
            let totalJpy = 0;

            expenses.forEach(expense => {
                const paymentMethod = expense.payment || '未知';
                if (!paymentSummary[paymentMethod]) {
                    paymentSummary[paymentMethod] = 0;
                }
                paymentSummary[paymentMethod] += expense.jpy;

                if (expense.notes) {
                    const cardName = expense.notes.trim();
                    if (!cardSummary[cardName]) {
                        cardSummary[cardName] = 0;
                    }
                    cardSummary[cardName] += expense.jpy;
                }
                totalJpy += expense.jpy;
            });

            summaryList.innerHTML = '';
            for (const method in paymentSummary) {
                const twd = Math.round(paymentSummary[method] * FIXED_RATE);
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `<td class="p-2 font-medium">${method}</td><td class="p-2">${paymentSummary[method].toLocaleString()} JPY</td><td class="p-2">${twd.toLocaleString()} TWD</td>`;
                summaryList.appendChild(row);
            }
             const totalTwd = Math.round(totalJpy * FIXED_RATE);
            const totalRow = document.createElement('tr');
            totalRow.className = 'font-bold bg-gray-50';
            totalRow.innerHTML = `<td class="p-2">總計</td><td class="p-2">${totalJpy.toLocaleString()} JPY</td><td class="p-2">${totalTwd.toLocaleString()} TWD</td>`;
            summaryList.appendChild(totalRow);
            
            cardSummaryList.innerHTML = '';
            if (Object.keys(cardSummary).length > 0) {
                 for (const card in cardSummary) {
                    const twd = Math.round(cardSummary[card] * FIXED_RATE);
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `<td class="p-2 font-medium">${card}</td><td class="p-2">${cardSummary[card].toLocaleString()} JPY</td><td class="p-2">${twd.toLocaleString()} TWD</td>`;
                    cardSummaryList.appendChild(row);
                }
            } else {
                cardSummaryList.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-4">無卡片/備註紀錄</td></tr>';
            }
        }

        function addExpense(event) {
            event.preventDefault();
            // ... (form reading logic)
            const newExpense = { date: expenseForm.elements['expense-date'].value, time: expenseForm.elements['expense-time'].value, location: expenseForm.elements['expense-location'].value, category: expenseForm.elements['expense-category'].value, desc: expenseForm.elements['expense-desc'].value, jpy: parseFloat(expenseForm.elements['expense-jpy'].value), payment: expenseForm.elements['expense-payment'].value, notes: expenseForm.elements['expense-notes'].value, };
            if (!newExpense.desc || isNaN(newExpense.jpy)) { return; }
            const expenses = getExpenses();
            expenses.push(newExpense);
            saveExpenses(expenses);
            expenseForm.reset();
        }

        function deleteExpense(index) {
            if (!confirm('確定要刪除這筆紀錄嗎？')) return;
            const expenses = getExpenses();
            expenses.splice(index, 1);
            saveExpenses(expenses);
        }

        function openEditModal(index) {
            const expenses = getExpenses();
            const expense = expenses[index];
            currentlyEditingIndex = index;
            
            editExpenseForm.elements['edit-expense-date'].value = expense.date;
            editExpenseForm.elements['edit-expense-time'].value = expense.time;
            editExpenseForm.elements['edit-expense-location'].value = expense.location;
            editExpenseForm.elements['edit-expense-category'].value = expense.category;
            editExpenseForm.elements['edit-expense-desc'].value = expense.desc;
            editExpenseForm.elements['edit-expense-jpy'].value = expense.jpy;
            editExpenseForm.elements['edit-expense-payment'].value = expense.payment;
            editExpenseForm.elements['edit-expense-notes'].value = expense.notes;

            editExpenseModal.style.display = 'block';
        }

        function closeEditModal() {
            currentlyEditingIndex = null;
            editExpenseModal.style.display = 'none';
        }
        
        function saveEditedExpense(event) {
            event.preventDefault();
            if (currentlyEditingIndex === null) return;
            
            const expenses = getExpenses();
            const editedExpense = { date: editExpenseForm.elements['edit-expense-date'].value, time: editExpenseForm.elements['edit-expense-time'].value, location: editExpenseForm.elements['edit-expense-location'].value, category: editExpenseForm.elements['edit-expense-category'].value, desc: editExpenseForm.elements['edit-expense-desc'].value, jpy: parseFloat(editExpenseForm.elements['edit-expense-jpy'].value), payment: editExpenseForm.elements['edit-expense-payment'].value, notes: editExpenseForm.elements['edit-expense-notes'].value, };

            expenses[currentlyEditingIndex] = editedExpense;
            saveExpenses(expenses);
            closeEditModal();
        }

        function exportToMarkdown() {
           const expenses = getExpenses();
            if (expenses.length === 0) { alert('沒有花費紀錄可匯出'); return; }

            let mdContent = '| 日期 | 時間 | 地點 | 類別 | 描述 | 日幣 | 台幣 | 支付 | 卡片/備註 |\n';
            mdContent += '|:---|:---|:---|:---|:---|---:|---:|:---|:---|\n';

            expenses.forEach(e => {
                const twd = Math.round(e.jpy * FIXED_RATE);
                mdContent += `| ${e.date || ''} | ${e.time || ''} | ${e.location || ''} | ${e.category || ''} | ${e.desc} | ${e.jpy} | ${twd} | ${e.payment} | ${e.notes || ''} |\n`;
            });
            
            mdContent += '\n### 依支付方式統計\n\n';
            mdContent += '| 支付方式 | 總金額 (JPY) | 總金額 (TWD) |\n|:---|---:|---:|\n';
            document.getElementById('summary-list').querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 3) {
                    mdContent += `| ${cells[0].innerText} | ${cells[1].innerText.replace(' JPY', '')} | ${cells[2].innerText.replace(' TWD', '')} |\n`;
                }
            });

            mdContent += '\n### 依卡片統計\n\n';
            mdContent += '| 卡片/備註 | 總金額 (JPY) | 總金額 (TWD) |\n|:---|---:|---:|\n';
             document.getElementById('card-summary-list').querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1 && !cells[0].innerText.includes('無卡片')) { 
                    mdContent += `| ${cells[0].innerText} | ${cells[1].innerText.replace(' JPY', '')} | ${cells[2].innerText.replace(' TWD', '')} |\n`;
                }
            });

            const blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tokyo-expenses.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // --- Suica Management Logic ---
        const suicaTopupForm = document.getElementById('suica-topup-form');
        const suicaBalanceEl = document.getElementById('suica-balance');
        const suicaTopupList = document.getElementById('suica-topup-list');
        const suicaStorageKey = 'tokyoSuicaTopups_v1';

        function getSuicaTopUps() { return JSON.parse(localStorage.getItem(suicaStorageKey)) || []; }
        function saveSuicaTopUps(topups) { localStorage.setItem(suicaStorageKey, JSON.stringify(topups)); renderAll(); }

        function renderSuicaCard() {
            const topups = getSuicaTopUps();
            const expenses = getExpenses();

            const totalTopUp = topups.reduce((sum, item) => sum + item.amount, 0);
            const totalSpent = expenses.filter(e => e.payment === 'Suica').reduce((sum, e) => sum + e.jpy, 0);
            const balance = totalTopUp - totalSpent;

            suicaBalanceEl.textContent = `¥ ${balance.toLocaleString()}`;

            suicaTopupList.innerHTML = '';
            if (topups.length > 0) {
                 topups.forEach((topup, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="p-2">${new Date(topup.date).toLocaleDateString()}</td>
                        <td class="p-2">${topup.amount.toLocaleString()}</td>
                        <td class="p-2 text-center"><button onclick="deleteSuicaTopUp(${index})" class="text-red-500 hover:text-red-700 text-xs">刪除</button></td>
                    `;
                    suicaTopupList.appendChild(row);
                });
            } else {
                 suicaTopupList.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-4">尚未有儲值紀錄</td></tr>';
            }
        }
        
        function addSuicaTopUp(event) {
            event.preventDefault();
            const amountInput = document.getElementById('suica-topup-amount');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) return;

            const topups = getSuicaTopUps();
            topups.push({ date: new Date().toISOString(), amount: amount });
            saveSuicaTopUps(topups);
            amountInput.value = '';
        }

        function deleteSuicaTopUp(index) {
            if (!confirm('確定要刪除這筆儲值紀錄嗎？')) return;
            const topups = getSuicaTopUps();
            topups.splice(index, 1);
            saveSuicaTopUps(topups);
        }

        // --- Shopping List Logic ---
        const shoppingListContainer = document.getElementById('shopping-list-container');
        const shoppingListStorageKey = 'tokyoShoppingList_v1';

        function getShoppingList() { return JSON.parse(localStorage.getItem(shoppingListStorageKey)) || { Mike: [], Edith: [], Nini: [], Ada: [] }; }
        function saveShoppingList(list) { localStorage.setItem(shoppingListStorageKey, JSON.stringify(list)); renderShoppingLists(); }

        function renderShoppingLists() {
            const shoppingList = getShoppingList();
            for (const person in shoppingList) {
                const listEl = document.getElementById(`shopping-list-${person.toLowerCase()}`);
                if (listEl) {
                    listEl.innerHTML = '';
                    shoppingList[person].forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between py-1';
                        li.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" onchange="toggleShopItem('${person}', ${index})" ${item.done ? 'checked' : ''} class="w-5 h-5 mr-3">
                                <span class="${item.done ? 'line-through text-gray-400' : ''}">${item.text}</span>
                            </label>
                            <button onclick="deleteShopItem('${person}', ${index})" class="text-red-400 hover:text-red-600 text-xs">刪除</button>
                    `;
                        listEl.appendChild(li);
                });
                }
            }
        }
        
        function addShopItem(person) {
            const inputEl = document.getElementById(`new-item-${person.toLowerCase()}`);
            const text = inputEl.value.trim();
            if (text === '') return;

            const shoppingList = getShoppingList();
            shoppingList[person].push({ text: text, done: false });
            saveShoppingList(shoppingList);
            inputEl.value = '';
        }

        function deleteShopItem(person, index) {
            const shoppingList = getShoppingList();
            shoppingList[person].splice(index, 1);
            saveShoppingList(shoppingList);
        }
        
        function toggleShopItem(person, index) {
            const shoppingList = getShoppingList();
            shoppingList[person][index].done = !shoppingList[person][index].done;
            saveShoppingList(shoppingList);
        }

        // --- Gemini API Logic for OCR ---
        const receiptUpload = document.getElementById('receipt-upload');
        const ocrStatus = document.getElementById('ocr-status');

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            ocrStatus.textContent = '正在讀取圖片...';
            ocrStatus.classList.remove('hidden');

            try {
                const base64Image = await fileToBase64(file);
                ocrStatus.textContent = '正在呼叫 AI 分析收據...';
                const result = await analyzeReceipt(base64Image);
                
                if (result.store) expenseForm.elements['expense-location'].value = result.store;
                if (result.item) expenseForm.elements['expense-desc'].value = result.item;
                if (result.total) expenseForm.elements['expense-jpy'].value = result.total;

                ocrStatus.textContent = 'AI 分析完成！請確認欄位內容。';
                setTimeout(() => ocrStatus.classList.add('hidden'), 3000);

            } catch (error) {
                console.error("OCR Error:", error);
                ocrStatus.textContent = `分析失敗：${error.message}`;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function analyzeReceipt(base64ImageData) {
            const apiKey = ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const payload = {
                contents: [
                    {
                        parts: [
                            { text: "請分析這張日本收據照片。以JSON格式回傳，包含店家名稱(store), 主要購買項目或描述(item), 以及總金額(total)。如果找不到就回傳空字串。範例: {\"store\": \"ドン・キホーテ\", \"item\": \"零食飲料\", \"total\": 5480}" },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            const jsonText = text.match(/\{.*\}/s)[0];
            return JSON.parse(jsonText);
        }
        
                // --- ToDo Checkbox state saving logic ---
        const checkboxStorageKey = 'tokyoTodoCheckboxStates_v1';

        function saveCheckboxStates() {
            const states = {};
            document.querySelectorAll('#todo-list input[type="checkbox"]').forEach((checkbox, index) => {
                states[`checkbox-${index}`] = checkbox.checked;
            });
            localStorage.setItem(checkboxStorageKey, JSON.stringify(states));
        }

        function loadCheckboxStates() {
            const states = JSON.parse(localStorage.getItem(checkboxStorageKey)) || {};
            document.querySelectorAll('#todo-list input[type="checkbox"]').forEach((checkbox, index) => {
                if (states[`checkbox-${index}`] !== undefined) {
                    checkbox.checked = states[`checkbox-${index}`];
                }
                checkbox.addEventListener('change', saveCheckboxStates);
            });
        }
        
        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            renderShoppingLists();
            loadCheckboxStates();
        });

        expenseForm.addEventListener('submit', addExpense);
        editExpenseForm.addEventListener('submit', saveEditedExpense);
        closeEditModalBtn.addEventListener('click', closeEditModal);
        suicaTopupForm.addEventListener('submit', addSuicaTopUp);
        exportBtn.addEventListener('click', exportToMarkdown);
        receiptUpload.addEventListener('change', handleImageUpload);
        
        // Add event listeners for shopping list forms
        document.getElementById('new-item-form-mike').addEventListener('submit', (e) => { e.preventDefault(); addShopItem('Mike'); });
        document.getElementById('new-item-form-edith').addEventListener('submit', (e) => { e.preventDefault(); addShopItem('Edith'); });
        document.getElementById('new-item-form-nini').addEventListener('submit', (e) => { e.preventDefault(); addShopItem('Nini'); });
        document.getElementById('new-item-form-ada').addEventListener('submit', (e) => { e.preventDefault(); addShopItem('Ada'); });

    </script>
</body>
</html>

